
jobs:
  trufflehog:
    runs-on: [self-hosted, devex]
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - if: ${{ github.event_name == 'pull_request' }}
        name: "🐷🔑 Leaked Secrets Pull Request Scan"
        run: |
          EXIT_CODE=0
          docker run -v "$(pwd)":/mnt/workdir --workdir=/mnt/workdir trufflesecurity/trufflehog:latest git --fail --json --no-update --only-verified --since-commit ${{ github.event.repository.default_branch }} --branch ${{ github.head_ref }} file://./ || EXIT_CODE=$?
          exit "${EXIT_CODE}"
      - if: ${{ github.event_name == 'workflow_dispatch' }}
        name: "🐷🔑 Leaked Secrets Scan"
        run: |
          EXIT_CODE=0
          docker run -v "$(pwd)":/mnt/workdir --workdir=/mnt/workdir trufflesecurity/trufflehog:latest git --debug --json --no-update --only-verified file://./ || EXIT_CODE=$?
          exit "${EXIT_CODE}"

name: leaked-cred-scan
on:
  pull_request:
  workflow_dispatch:
  schedule:
  - cron: '*/5 * * * *'